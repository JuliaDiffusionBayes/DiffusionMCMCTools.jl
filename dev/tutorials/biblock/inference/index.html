<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Inference · DiffusionMCMCTools.jl</title><link rel="canonical" href="https://JuliaDiffusionBayes.github.io/DiffusionMCMCTools.jl/tutorials/biblock/inference/"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../"><img src="../../../assets/logo.png" alt="DiffusionMCMCTools.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit">DiffusionMCMCTools.jl</span></div><form class="docs-search" action="../../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><a class="tocitem" href="../../../get_started/overview/">Get started</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">User manual</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../manual/sampling_unit/">SamplingUnit</a></li><li><a class="tocitem" href="../../../manual/sampling_pair/">SamplingPair</a></li><li><a class="tocitem" href="../../../manual/sampling_ensemble/">SamplingEnsemble</a></li><li><a class="tocitem" href="../../../manual/block/">Block</a></li><li><a class="tocitem" href="../../../manual/biblock/">BiBlock</a></li><li><a class="tocitem" href="../../../manual/block_collection/">BlockCollection</a></li><li><a class="tocitem" href="../../../manual/block_ensemble/">BlockEnsemble</a></li><li><a class="tocitem" href="../../../manual/param_names_collections/">Containers for parameter names</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">How to...</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../how_to_guides/under_construction/">...</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox" checked/><label class="tocitem" for="menuitem-5"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../preamble/">⚠ Preamble ⚠</a></li><li><input class="collapse-toggle" id="menuitem-5-2" type="checkbox" checked/><label class="tocitem" for="menuitem-5-2"><span class="docs-label">BiBlocks</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../smoothing/">Smoothing</a></li><li><a class="tocitem" href="../smoothing_with_blocking/">Smoothing with blocking</a></li><li class="is-active"><a class="tocitem" href>Inference</a><ul class="internal"><li><a class="tocitem" href="#The-algorithm-1"><span>The algorithm</span></a></li><li><a class="tocitem" href="#Results-1"><span>Results</span></a></li></ul></li><li><a class="tocitem" href="../inference_with_blocking/">Inference with blocking</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-3" type="checkbox"/><label class="tocitem" for="menuitem-5-3"><span class="docs-label">Containers for parameter names</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../pnames/inference_with_biblock/">Inference with BiBlocks</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-4" type="checkbox"/><label class="tocitem" for="menuitem-5-4"><span class="docs-label">BlockCollection</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../block_collection/inference/">Inference</a></li><li><a class="tocitem" href="../../block_collection/inference_with_blocking/">Inference with blocking</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-5" type="checkbox"/><label class="tocitem" for="menuitem-5-5"><span class="docs-label">BlockEnsemble</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../block_ensemble/inference/">Inference</a></li></ul></li></ul></li><li><a class="tocitem" href="../../../module_index/">Index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li><a class="is-disabled">BiBlocks</a></li><li class="is-active"><a href>Inference</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Inference</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaDiffusionBayes/DiffusionMCMCTools.jl/blob/master/docs/src/tutorials/biblock/inference.md#L" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Inference-with-BiBlocks-1"><a class="docs-heading-anchor" href="#Inference-with-BiBlocks-1">Inference with <code>BiBlock</code>s</a><a class="docs-heading-anchor-permalink" href="#Inference-with-BiBlocks-1" title="Permalink"></a></h1><hr/><div class="admonition is-info"><header class="admonition-header">important</header><div class="admonition-body"><p>Make sure that you read the <a href="tutorials/biblock/@id tutorials_start">preamble</a> before you start reading this tutorial.</p></div></div><p>Another level of complication to a smoothing algorithm, somewhat orthogonal to blocking is addition of an inference step. Let&#39;s forget about blocking for this tutorial (we will come back to it the subsequent tutorial) and focus on inference only.</p><h2 id="The-algorithm-1"><a class="docs-heading-anchor" href="#The-algorithm-1">The algorithm</a><a class="docs-heading-anchor-permalink" href="#The-algorithm-1" title="Permalink"></a></h2><hr/><pre><code class="language-julia">customkernel(θ, scale=0.1) = θ .+ 2.0*scale*(rand()-0.5)

#=
    NOTE: this will appear to be completely unnecessary and coming out of the
    blue if you are not considering more complicated settings of mixed effect
    models. Looking up ahead into the definition of ... should be helpful if
    you want to understand what the function below is aiming to do.

    In here, we are just creating the most basic struture that is needed for
    setting parameters. It can be much more complex if blocking, multiple
    updates and/or mixed effect models were used.
=#
#↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓ ↓
_build_struct(N, args...) = (
    var = tuple(),
    var_aux = fill(tuple(), N),
    updt = tuple(args...),
    updt_aux = fill(tuple(args...), N),
    updt_obs = fill(tuple(), N),
)

function simple_name_structure(pname::Symbol, num_obs)
    pnames = (
        PP = _build_struct(num_obs, (1=&gt;pname)),
        P_last = _build_struct(0), # was num_obs
        P_excl = _build_struct(0),
        Pb_excl = _build_struct(num_obs, (1=&gt;pname)),
    )
end
#↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑

function accept_reject_proposal_param!(bb, mcmciter, θ, θ°)
    accepted = rand(Exponential(1.0)) &gt; -(bb.b°.ll - bb.b.ll)
    accepted &amp;&amp; swap_XX!(bb)
    accepted &amp;&amp; swap_PP!(bb)
    save_ll!(bb, mcmciter)
    accepted &amp;&amp; swap_ll!(bb)
    accepted, copy(accepted ? θ° : θ)
end

function simple_inference(AuxLaw, recording, dt, _θ; ϵ=0.3, ρ=0.5, num_steps=10^4)
    # making sure that things are in order...
    _pname = collect(keys(_θ))
    # for simplicity restrict to inference for a single param
    @assert length(_pname) == 1
    pname = first(_pname)
    θ = collect(values(_θ))

    # setting the initial guess θ inside the recording
    OBS.set_parameters!(recording, _θ)

    # setting up containers
    num_obs = length(recording.obs)
    tts = OBS.setup_time_grids(recording, dt, standard_guid_prop_time_transf)
    sp = SamplingPair(AuxLaw, recording, tts)
    bb = BiBlock(sp, 1:num_obs, ρ, true, num_steps)
    name_struct = simple_name_structure(pname, num_obs)

    loglikhd!(bb)
    paths = []

    θθ = [θ]
    a_h = Bool[]

    for i in 1:num_steps
        draw_proposal_path!(bb)
        accept_reject_proposal_path!(bb, i)

        θ° = customkernel(θ, ϵ)
        set_proposal_law!(bb, θ°, name_struct, true)

        accpt, θ = accept_reject_proposal_param!(bb, i, θ, θ°)
        push!(θθ, θ)
        push!(a_h, accpt)

        # progress message
        if i % 100 == 0
            println(
                &quot;$i. ll=$(ll_of_accepted(bb, i)), &quot;,
                &quot;imp a-r: &quot;,
                &quot; $(accpt_rate(bb, (i-99):i)), &quot;,
                &quot;updt a-r: &quot;,
                &quot;$(sum(a_h[(i-99):i])/100).&quot;
            )
        end

        # save intermediate path for plotting
        i % 400 == 0 &amp;&amp; append!(paths, [deepcopy(sp.u.XX)])
    end
    paths, θθ
end</code></pre><h2 id="Results-1"><a class="docs-heading-anchor" href="#Results-1">Results</a><a class="docs-heading-anchor-permalink" href="#Results-1" title="Permalink"></a></h2><hr/><pre><code class="language-julia">plot(getindex.(θθ, 1))</code></pre><p><img src="../../../assets/tutorials/biblock/inference_chain.png" alt="inference_chain"/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../smoothing_with_blocking/">« Smoothing with blocking</a><a class="docs-footer-nextpage" href="../inference_with_blocking/">Inference with blocking »</a></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Tuesday 30 June 2020 15:11">Tuesday 30 June 2020</span>. Using Julia version 1.4.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
